## Kubernetes JobSet

JobSet is a Kubernetes-native API for managing groups of Kubernetes Jobs as a unit, designed for distributed AI/ML training workloads (PyTorch, Jax, TensorFlow) and HPC applications (MPI). It is a Kubernetes SIG (Special Interest Group) project maintained under kubernetes-sigs.

## Agent Behavior Policy

AI agents should:

- Make atomic, minimal, and reversible changes.
- Prefer local analysis (`make test`, `make build`, `make test-integration`, `make verify`) before proposing commits.
- NEVER modify CI/CD workflows or release automation unless explicitly requested.
- Use `AGENTS.md` and `Makefile` as the source of truth for development commands.

Agents must NOT:

- Bypass tests or linters
- Introduce dependencies without updating `go.mod`
- Generate or commit large autogenerated files
- Modify CRD schemas or API versions without explicit instruction

### Context Awareness

Before writing code, agents should:

- Read existing test cases for pattern alignment
- Match import patterns from neighboring files
- Preserve existing logging and error-handling conventions
- Review CRD schemas in `api/jobset/v1alpha2/` before changing API structures
- Call out any breaking changes and follow the deprecation policy

## Repository Map

```
jobset/
├── api/jobset/v1alpha2/        # API types (JobSet, ReplicatedJob); edit here for API changes
├── charts/                     # Helm Charts to deploy JobSet
├── client-go/                  # Generated typed clientsets, informers, listers
├── cmd/                        # Controller manager entrypoint (main.go is at root)
├── config/                     # Kustomize manifests to deploy JobSet
├── hack/                       # Code generation, boilerplate, deploy scripts
├── keps/                       # Enhancement proposals for JobSet
├── pkg/
│   ├── config/                 # JobSet configuration ConfigMap
│   ├── constants/              # All annotation, label, and env var key constants
│   ├── controllers/            # JobSet and Pod reconcilers, failure/success/TTL policies
│   ├── features/               # Feature gate definitions
│   ├── metrics/                # Prometheus metric definitions and registration
│   ├── util/                   # Shared utilities (collections, placement)
│   ├── version/                # Version info
│   └── webhooks/               # Validating and mutating webhook handlers
├── site/                       # Hugo + Docsy documentation site
└── test/
    ├── e2e/                    # End-to-end tests (Kind cluster)
    └── integration/            # envtest based integration tests
```

## Commands

<!-- BEGIN: AGENT_COMMANDS -->

### Building and Testing

```bash
# Build the manager binary
make build

# Run unit tests
make test

# Run integration tests
make test-integration

# Run E2E tests on Kind cluster
make test-e2e-kind

# Run specific test (use Ginkgo focus)
GINKGO_ARGS="-focus='specific test pattern'" make test-integration

# Format code
make fmt

# Run linters
make ci-lint        # General linting
make lint-api       # API-specific linting with golangci-lint-kal
make lint-api-fix   # Auto-fix API linting issues

# Run vet
make vet

# Full verification (runs before commits)
make verify
```

### Code Generation

JobSet uses extensive code generation for Kubernetes clients and CRDs. After modifying API types or adding new fields:

```bash
# Generate all: manifests, DeepCopy methods, client-go libraries, Python SDK
make generate

# Generate only CRDs and RBAC manifests
make manifests

# Update API reference documentation
make generate-apiref
```

### Building and Deploying Images

```bash
# Build image for Kind (local testing)
make kind-image-build

# Build multi-platform image
make image-build

# Build and push image (requires registry access)
make image-push

# Set custom registry/tag (recommended for development):
export GIT_TAG="dev-$(date +%Y-%m-%d-%H%M%S)"
export IMAGE_REGISTRY=<YOUR_IMAGE_REGISTRY_URL>
make image-push
```

### Kubernetes Deployment

```bash
# Install CRDs only
make install

# Deploy controller to cluster
make deploy

# Redeploy after code changes
make undeploy deploy

# Uninstall CRDs
make uninstall
```

### Documentation

```bash
# Serve documentation site locally (Hugo + Docsy)
make site-serve

# Build documentation site
make site-build

# Update table of contents in documentation
make toc-update
```

### Helm

```bash
# Run Helm chart unit tests
make helm-unittest

# Lint Helm chart
make helm-lint

# Verify Helm chart
make helm-verify

# Package Helm chart
make helm-chart-package
```

<!-- END: AGENT_COMMANDS -->

## Architecture Overview

### Core Components

1. **JobSet Controller** (`pkg/controllers/jobset_controller.go`)
   - Main reconciliation loop managing JobSet lifecycle
   - Handles creation, deletion, and updates of child Jobs
   - Implements restart logic and failure recovery
   - Coordinates with child Jobs to determine overall JobSet status

2. **Pod Controller** (`pkg/controllers/pod_controller.go`)
   - Watches Pods created by JobSet-owned Jobs
   - Updates JobSet status based on Pod readiness
   - Supports startup sequencing and dependency management

3. **Webhooks** (`pkg/webhooks/`)
   - **Validating Webhook** (`jobset_webhook.go`): Validates JobSet specs before admission
   - **Pod Mutating Webhook** (`pod_mutating_webhook.go`): Injects environment variables and configuration into Pods
   - **Pod Admission Webhook** (`pod_admission_webhook.go`): Enforces exclusive placement constraints

### API Structure

- **API Version**: `jobset.x-k8s.io/v1alpha2` (`api/jobset/v1alpha2/`)
- **Main Types**:
  - `JobSet`: Top-level resource representing a group of Jobs
  - `ReplicatedJob`: Specification for creating multiple identical Jobs
  - Each ReplicatedJob can have different pod templates (e.g., leader, workers, parameter servers)

### Key Concepts

1. **ReplicatedJobs**: JobSet contains one or more ReplicatedJobs, each creating `replicas` number of Jobs
2. **Automatic Networking**: Uses IndexedJobs + headless services for stable pod hostnames and DNS records
3. **Restart Semantics**: On failure, entire JobSet is restarted
4. **Exclusive Placement**: Annotation-based exclusive topology placement for performance isolation
5. **Startup Sequencing**: Leader-worker patterns where certain Jobs must be ready before others start
6. **Integration with Kueue**: Queue-based resource management for multi-tenancy

### Testing Structure

- **Unit Tests**: Co-located with source files (`*_test.go`)
  - Use `testify/assert` for assertions
  - Use `testify/require` for fatal assertions
- **Integration Tests**: `test/integration/` - uses envtest (fake API server)
- **E2E Tests**: `test/e2e/` - uses real Kubernetes clusters (Kind for CI)
  - Uses Ginkgo/Gomega frameworks

**Requirements:**

- Every new feature or bug fix must include tests
- Unit tests go in the same package as the source file (`*_test.go`)
- Integration tests go in `test/integration/`
- Use table-driven tests (map or slice of structs) for multiple scenarios

### Code Generation Tools

JobSet uses multiple code generators (all invoked via `make generate`):

- **controller-gen**: Generates CRDs, RBAC, and webhook configs from Go markers
- **client-gen**: Generates typed clientsets for jobset resources
- **openapi-gen**: Generates OpenAPI spec for API validation
- **Python SDK generator**: `hack/python-sdk/gen-sdk.sh` generates Python client library

## Development Workflow for AI Agents

**Before making changes:**

1. Read existing code patterns, comments, and tests in neighboring files
2. Check `pkg/constants/constants.go` for annotation/label keys before defining new ones
3. Run `make verify` to establish a clean baseline before editing
4. Check the Core Development Principles below

**Commit and PR hygiene:**

- Follow the [Kubernetes commit message convention](https://www.kubernetes.dev/docs/guide/pull-requests/#commit-message-guidelines):
  short imperative subject, blank line, then body explaining the "why"
- Include rationale ("why") in commit messages and PR descriptions, not just "what"
- Only modify files relevant to the task; keep diffs minimal
- Do not push secrets or modify git config
- Always run `make generate` after modifying the source code

## Core Development Principles

### API Stability ⚠️ CRITICAL

JobSet's API (`jobset.x-k8s.io/v1alpha2`) is in alpha. Always preserve backward compatibility within a version.

**Rules for API changes** (`api/jobset/v1alpha2/jobset_types.go`):

- **Adding fields**: Use `+optional` marker and provide a default where possible
- **Removing or renaming fields**: Requires an API version bump and a migration plan — do not do this without explicit instruction
- **Changing field types**: Breaking change; requires a deprecation period
- **Validation**: Use [CEL validation](https://kubernetes.io/docs/reference/using-api/cel/) (`+kubebuilder:validation:XValidation`) wherever applicable instead of webhook-only validation
- **Always call out breaking changes** in PR descriptions and commit messages

❌ **Bad — silent breaking change:**

```go
type JobSetSpec struct {
    // Renamed without migration
    Paused *bool `json:"paused,omitempty"`
}
```

✅ **Good — backward compatible addition:**

```go
type JobSetSpec struct {
    // Suspend stops the JobSet without deleting resources.
    // +optional
    Suspend *bool `json:"suspend,omitempty"`

    // NewFeature enables experimental capability X.
    // +optional
    NewFeature *bool `json:"newFeature,omitempty"`
}
```

**After any API change:**

1. Add `+kubebuilder` markers for validation, defaulting, or CRD generation
2. Run `make generate` to update generated code
3. Run `make verify` to confirm all generated artifacts are up to date

### E2E Test Environment Variables

- `KIND_CLUSTER_NAME`: Name of Kind cluster (default: "kind")
- `USE_EXISTING_CLUSTER`: Set to "true" to test against existing cluster instead of creating new Kind cluster
- `E2E_KIND_VERSION`: Kubernetes version for Kind cluster (default: kindest/node:v1.34.0)
- `E2E_TARGET`: Test target pattern (default: ./test/e2e/...)

### Webhook Development

Webhooks run as part of the JobSet controller manager. When testing locally:

- Webhooks require valid TLS certificates
- Use `cert-controller` package for certificate management
- Webhook configurations are in `config/components/webhook/`

### Metrics

JobSet exposes Prometheus metrics via `pkg/metrics/`. When adding new metrics, follow the existing pattern and register them in the metrics package init function.
